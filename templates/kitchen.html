<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 1rem; }
        h2 { color: #66ff99; margin-bottom: 1rem; }
        .utensil { background: #222; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 6px; transition: background 0.3s; }
        .utensil.updated { background: #336633; }
        .utensil-name { font-weight: bold; font-size: 1.1em; }
        .utensil-data { font-family: monospace; white-space: pre-wrap; margin-top: 0.3rem; }
        .timestamp { font-size: 0.8em; color: #888; margin-top: 0.2rem; }
    </style>
</head>

<body>
<h2>Kitchen Dashboard</h2>
<div id="utensils"></div>
<div id="global-status" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.2em;
    padding: 0.5rem;
    background: #222;
    color: #eee;
">hi</div>

<script>
    const socket = io();
    const latestData = {
        cutting_board: null,
        pan: null,
        mixing_bowl: null,
    };

    socket.on('connect', () => {
        console.log('Connected to viewer');
    });

    socket.on('mqtt_message', (message) => {
        const payloadClass = message.is_json ? 'json' : 'text';
        const payloadString = message.payload
        const payload = JSON.parse( message.payload)
        latestData[payload.utensil] = payload
        console.log(payload)
        renderUtensils();
    });

    function checkUtensilTarget(utensil) {
        console.log('checkUtensilTarget')
        if (utensil == 'pan') { // for testing
            console.log('asdjkh')
            const payload = latestData[utensil];
            // const config = targetConfig[utensil];
            // if (!payload || config.currentTarget === null) return false;

            const value = payload.data.value;
            // const div = document.querySelector(`#utensils .utensil[data-utensil="${utensil}"]`);
            // if (!div) return false;
            console.log("helo")

            // if (value >= config.min && value <= config.max) {
            if (value >= 2 && value <= 50) {
                console.log("in right range")
                // div.style.background = '#339933'; // green
                // div.querySelector('.message')?.remove();
                return true;
            } else {
                // div.style.background = '#222'; // default
                // if (!div.querySelector('.message')) {
                //     const msg = document.createElement('div');
                //     msg.className = 'message';
                //     msg.style.color = '#ff4444';
                //     msg.textContent = `Missed target!`;
                //     // div.appendChild(msg);
                // }
                return false;
            }
        }
    }

    function updateGlobalStatus() {
        const allInRange = Object.keys(latestData).every(utensil => checkUtensilTarget(utensil));
        const statusDiv = document.getElementById('global-status');
        if (allInRange) {
            statusDiv.textContent = "âœ… All utensils are within range!";
            statusDiv.style.background = "#336633";
        } else {
            statusDiv.textContent = "";
            statusDiv.style.background = "#222";
        }
    }
        
    function renderUtensils(data) {
        const container = document.getElementById("utensils");
        container.innerHTML = "";
        for (const [utensil, payload] of Object.entries(latestData)) {
            if (payload != null){
                const div = document.createElement("div");
                div.className = "utensil updated";
                div.id = utensil
                div.innerHTML = `
                <div class="utensil-name">${utensil}</div>
                <div class="utensil-data">${JSON.stringify(payload.data, null, 2)}</div>
                <div class="timestamp">timestamp: ${payload.timestamp}</div>
                `;
                container.appendChild(div);
                // remove highlight after 300ms
                setTimeout(() => div.classList.remove("updated"), 300);
                checkUtensilTarget(utensil);
            }
        }
        updateGlobalStatus();
    }
</script>
</body>
</html>
